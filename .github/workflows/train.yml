name: Train ML Model

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      model_type:
        description: 'Model type'
        required: true
        default: 'use'
        type: choice
        options:
          - use
          - bert
      epochs:
        description: 'Number of epochs'
        required: true
        default: '10'
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
  
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1

jobs:
  train:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    environment:
      name: ${{ inputs.environment || 'dev' }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
    
    - uses: google-github-actions/setup-gcloud@v2
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create output directory
      run: mkdir -p models artifacts
    
    - name: Train model
      env:
        PYTHONPATH: ${{ github.workspace }}
        TF_CPP_MIN_LOG_LEVEL: '3'
      run: |
        python src/training/train.py \
          --project-id ${{ env.PROJECT_ID }} \
          --dataset-id consumer_complaints \
          --table-id complaints_${{ inputs.environment || 'dev' }} \
          --model-type ${{ inputs.model_type || 'use' }} \
          --epochs ${{ inputs.epochs || '10' }} \
          --output-path ./models \
          --save-format tf \
          --use-class-weights \
          --early-stopping \
          --patience 5 \
          --verbose 1
    
    - name: Evaluate model
      run: |
        python src/evaluation/evaluate.py \
          --model-path ./models \
          --output-path ./artifacts
    
    - name: Upload model to GCS
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        MODEL_VERSION="${{ inputs.model_type || 'use' }}-${TIMESTAMP}"
        
        gsutil -m cp -r ./models/* \
          gs://${{ secrets.GCS_BUCKET }}/models/${MODEL_VERSION}/
        
        gsutil -m cp -r ./artifacts/* \
          gs://${{ secrets.GCS_BUCKET }}/artifacts/${MODEL_VERSION}/
        
        echo "MODEL_VERSION=${MODEL_VERSION}" >> $GITHUB_ENV
    
    - name: Register model in Vertex AI
      run: |
        gcloud ai models upload \
          --region=${{ env.REGION }} \
          --display-name="${{ inputs.model_type }}-${{ inputs.environment }}" \
          --artifact-uri=gs://${{ secrets.GCS_BUCKET }}/models/${{ env.MODEL_VERSION }} \
          --container-image-uri=gcr.io/cloud-aiplatform/prediction/tf2-cpu.2-13:latest
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: training-artifacts-${{ env.MODEL_VERSION }}
        path: |
          ./models
          ./artifacts
        retention-days: 30