name: Deploy Model

on:
  workflow_dispatch:
    inputs:
      model_version:
        description: 'Model version to deploy'
        required: true
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  PROJECT_ID: project-37461c1b-635d-4cf2-af5
  REGION: us-central1
  BUCKET_NAME: project-37461c1b-635d-4cf2-af5d-mlops-models 
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
    
    - uses: google-github-actions/setup-gcloud@v2
    
    - name: Download model from GCS
      run: |
        gsutil -m cp -r \
          gs://${{ secrets.GCS_BUCKET }}/models/${{ inputs.model_version }} \
          ./model
    
    - name: Deploy to Vertex AI Endpoint
      id: deploy
      run: |
        # Create or get endpoint
        ENDPOINT_NAME="complaints-classifier-${{ inputs.environment }}"
        
        ENDPOINT_ID=$(gcloud ai endpoints list \
          --region=${{ env.REGION }} \
          --filter="displayName:${ENDPOINT_NAME}" \
          --format="value(name)" | head -1)
        
        if [ -z "$ENDPOINT_ID" ]; then
          ENDPOINT_ID=$(gcloud ai endpoints create \
            --region=${{ env.REGION }} \
            --display-name="${ENDPOINT_NAME}" \
            --format="value(name)")
        fi
        
        # Deploy model
        gcloud ai endpoints deploy-model $ENDPOINT_ID \
          --region=${{ env.REGION }} \
          --model=${{ inputs.model_version }} \
          --display-name="deployment-$(date +%Y%m%d-%H%M%S)" \
          --machine-type=n1-standard-4 \
          --min-replica-count=1 \
          --max-replica-count=3 \
          --traffic-split=0=100
        
        ENDPOINT_URL="https://${REGION}-aiplatform.googleapis.com/v1/${ENDPOINT_ID}"
        echo "url=${ENDPOINT_URL}" >> $GITHUB_OUTPUT
    
    - name: Run smoke tests
      run: |
        python tests/integration/test_endpoint.py \
          --endpoint-id ${{ steps.deploy.outputs.endpoint_id }} \
          --region ${{ env.REGION }}
    
    - name: Notify deployment
      if: always()
      run: |
        # Send notification (Slack, email, etc.)
        echo "Deployment completed for ${{ inputs.environment }}"